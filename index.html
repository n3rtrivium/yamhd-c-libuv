<!DOCTYPE html>

<html>
<head>
  <title>yamhd-c-libuv.c</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>yamhd-c-libuv.c</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>(c) <span class="hljs-number">2014</span> Martin Wind
</code></pre><p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>
<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h3 id="yet-another-minimal-http-daemon">Yet another minimal HTTP daemon</h3>
<p>This is not a real server and never will be.
See <a href="https://github.com/kellabyte/Haywire">Haywire</a> for an asynchronous
HTTP server framework on top of libuv.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-preprocessor">#include &lt;stdio.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;string.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;sys/stat.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;time.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;uv.h&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h3 id="defines-and-function-declaration">Defines and function declaration</h3>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>If the request contains a <code>path</code> bigger than <code>MAX_PATH_SIZE</code> discard it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">#define MAX_PATH_SIZE 256</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Read files in chunks of size <code>READ_BUF_SIZE</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">#define READ_BUF_SIZE 4096</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Allocate <code>HEADERS_BUF_SIZE</code> for generated response headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-preprocessor">#define HEADERS_BUF_SIZE 1024</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Comment / uncommet this line to toggle debug mode.</p>
<h1 id="define-debug_build">define DEBUG_BUILD</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-preprocessor">#ifdef DEBUG_BUILD</span>
<span class="hljs-preprocessor">#  define DEBUG(...) fprintf(stderr, __VA_ARGS__)</span>
<span class="hljs-preprocessor">#else</span>
<span class="hljs-preprocessor">#  define DEBUG(...) do {} while (0)</span>
<span class="hljs-preprocessor">#endif</span>

<span class="hljs-keyword">static</span> uv_loop_t *loop;
<span class="hljs-keyword">static</span> uv_tcp_t tcp_server;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span>* web_root;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> web_root_len;

<span class="hljs-preprocessor">#ifdef DEBUG_BUILD</span>
<span class="hljs-keyword">static</span> size_t concurrent_states = <span class="hljs-number">0</span>;
<span class="hljs-preprocessor">#endif</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h1 id="activity-diagram">Activity diagram</h1>
<pre><code>             +-+
             +-+
              |
              |
     +--------v--------+
     |                 |
     |  on_connection  |     create state
     |                 |
     +--------+--------+
              |
              |
              |
     +--------v--------+
     |                 |     parse headers
 +---+   on_tcp_read   |     open file
 |   |                 |     close on error
 |   +--------+--------+
 |            |
 |            |
 |            |
 |   +--------v--------+     close on error
 |   |                 &lt;--+  reopen on directory
 +---+  on_file_open   |  |  send <span class="hljs-number">404</span> on ENOENT
 |   |                 +--+  send <span class="hljs-number">200</span> header
 |   +--------+--------+     read file
 |            |
 |            |
 |            |
 |   +--------v--------+
 |   |                 |     close on error
 +---+  on_tcp_write   &lt;--+  or close flag
 |   |                 |  |  read next file buffer
 |   +--------+--------+  |
 |            |           |
 |            |           |
 |            |           |
 |   +--------v--------+  |
 |   |                 |  |  close on error
 |   |  on_file_read   +--+  close on EOF
 |   |                 |     send file buffer
 |   +--------+--------+
 |            |
 |            |
 |            |
 |   +--------v--------+
 |   |                 |
 +---&gt;    on_close     |     close the stream
     |                 |
     +-----------------+
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h1 id="event-handler">Event handler</h1>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li><strong><a href="#on-connection">on connection</a></strong></li>
<li><strong><a href="#on-tcp-read">on tcp read</a></strong></li>
<li><strong><a href="#on-tcp-write">on tcp write</a></strong></li>
<li><strong><a href="#on-file-open">on file open</a></strong></li>
<li><strong><a href="#on-file-read">on file read</a></strong></li>
<li><strong><a href="#on-tcp-write">on tcp write</a></strong></li>
<li><strong><a href="#on-close">on close</a></strong></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_connection(uv_stream_t*, <span class="hljs-keyword">int</span> status);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_tcp_read(uv_stream_t*, ssize_t nread, <span class="hljs-keyword">const</span> uv_buf_t* buf);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_file_open(uv_fs_t* req);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_tcp_write(uv_write_t* req, <span class="hljs-keyword">int</span> status);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_file_read(uv_fs_t * req);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_close(uv_handle_t* peer);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h1 id="state-struct">State struct</h1>
<p>This struct is passed to all handlers to keep track of the state.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <ul>
<li><strong>stream</strong>:  Socket handle.</li>
<li><strong>file</strong>: File handle.</li>
<li><strong>method</strong>: HTTP method (currently not used).</li>
<li><strong>path</strong>: The mapped filesystem path.</li>
<li><strong>path_len</strong>: The length of the mapped filesystem path.</li>
<li><strong>content_type</strong>: The content type header.</li>
<li><strong>content_type_len</strong>: See <a href="http://www.ietf.org/rfc/rfc4288.txt?number=4288s">RFC 4288</a> 
4.2 for the max length.</li>
<li><strong>close_after_write (flag)</strong>: Close the connection after the next write.</li>
<li><strong>read_on_write (flag)</strong>: Read from file after the next write.</li>
<li><strong>dead (flag)</strong>: Other request has returned an error. Expect an broken stream or
file handle.</li>
<li><strong>file_pos</strong>: Position in the file.</li>
<li><strong>file_buf</strong>: Buffer used to pipe data from a file to a tcp stream.</li>
<li><strong>headers_buf</strong>: Buffer for generated headers.</li>
<li><strong>pending_requests</strong>: Count of outstanding and dispatched requests.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
	uv_stream_t* stream;
	<span class="hljs-keyword">int</span> file;
	<span class="hljs-keyword">char</span>* method[<span class="hljs-number">8</span>];
	<span class="hljs-keyword">char</span>* path;
	size_t path_len;
	<span class="hljs-keyword">char</span>* content_type[<span class="hljs-number">256</span>];
	size_t content_type_len;
	<span class="hljs-keyword">int</span> close_after_write;
	<span class="hljs-keyword">int</span> read_on_write;
	<span class="hljs-keyword">int</span> dead;
	size_t file_pos;
	uv_buf_t* file_buf;
	uv_buf_t* headers_buf;
	<span class="hljs-keyword">int</span> pending_requests;
} req_res_t;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h1 id="event-dispatcher">Event dispatcher</h1>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <ul>
<li><strong><a href="#open-path-as-file">open path as file</a></strong>: Open the <code>path</code>.</li>
<li><strong><a href="#send-headers-buf">send headers buf</a></strong>: Send the headers buffer.</li>
<li><strong><a href="#send-file-buf">send file buf</a></strong>: Send the file buffer.</li>
<li><strong><a href="#read-file">read file</a></strong>: Fill the file buffer.</li>
<li><strong><a href="#">req res free</a></strong>: Close the stream and file handle. Free the memory of the state.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> open_path_as_file(req_res_t *rr);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_headers_buf(req_res_t* rr);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_file_buf(req_res_t* rr);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> read_file(req_res_t *rr);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> req_res_free(req_res_t* rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h2 id="helpers">Helpers</h2>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <ul>
<li><strong><a href="#send-not-found">send not found</a></strong>: Send a <code>404</code> response.</li>
<li><strong><a href="#set-headers-helper">set headers</a></strong>: Set the headers buffer.</li>
<li><strong><a href="#simple-request-header-parser">parse</a></strong>: Simple request header parser.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_not_found(req_res_t* rr);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> set_headers(req_res_t* rr, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* code);
<span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>  parse(<span class="hljs-keyword">const</span> uv_buf_t* req, req_res_t* rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h1 id="stop-reading-">Stop reading!</h1>
<p>Since this file starts with utility functions it is a good idea to read 
the file bottom up. <a href="#main">Goto main</a></p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2 id="state">State</h2>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h3 id="req-res-init">req res init</h3>
<p>This function ensures the default values of the state struct. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> req_res_t* req_res_init(uv_stream_t* handle) {
	req_res_t* rr = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(req_res_t));
	<span class="hljs-keyword">if</span> (rr == NULL) <span class="hljs-keyword">return</span> NULL;
	rr-&gt;stream = handle;
	rr-&gt;file = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">memset</span>(rr-&gt;method, <span class="hljs-string">'\0'</span>, <span class="hljs-number">8</span>);
	rr-&gt;path = NULL;
	rr-&gt;path_len = <span class="hljs-number">0</span>;
	<span class="hljs-built_in">memset</span>(rr-&gt;content_type, <span class="hljs-string">'\0'</span>, <span class="hljs-number">256</span>);
	rr-&gt;content_type_len = <span class="hljs-number">0</span>;
	rr-&gt;close_after_write = <span class="hljs-number">0</span>;
	rr-&gt;read_on_write = <span class="hljs-number">0</span>;
	rr-&gt;dead = <span class="hljs-number">0</span>;
	rr-&gt;file_pos = <span class="hljs-number">0</span>;
	rr-&gt;file_buf = NULL;
	rr-&gt;headers_buf = NULL;
	rr-&gt;pending_requests = <span class="hljs-number">0</span>;

	DEBUG(<span class="hljs-string">"concurrent_states (+1): %zu\n"</span>, ++concurrent_states);
	<span class="hljs-keyword">return</span> rr;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h4 id="req-res-init-file-buf">req res init file buf</h4>
<p>Initialize the read buffer of the sate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> req_res_init_file_buf(req_res_t* rr) {
	<span class="hljs-keyword">if</span> (rr-&gt;file_buf != NULL) {
		DEBUG(<span class="hljs-string">"req_res_init_file_buf error: read not NULL\n"</span>);
		<span class="hljs-keyword">return</span>;
	}
	rr-&gt;file_buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_buf_t));
	rr-&gt;file_buf-&gt;base = <span class="hljs-built_in">malloc</span>(READ_BUF_SIZE);
	rr-&gt;file_buf-&gt;len = READ_BUF_SIZE;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h4 id="req-res-init-headers-buf">req res init headers buf</h4>
<p>Initialize the headers buffer of the sate.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> req_res_init_headers_buf(req_res_t* rr) {
	<span class="hljs-keyword">if</span> (rr-&gt;headers_buf != NULL) {
		DEBUG(<span class="hljs-string">"req_res_init_headers_buf error: header not NULL\n"</span>);
		<span class="hljs-keyword">return</span>;
	}
	rr-&gt;headers_buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_buf_t));
	rr-&gt;headers_buf-&gt;base = <span class="hljs-built_in">malloc</span>(HEADERS_BUF_SIZE);
	rr-&gt;headers_buf-&gt;len = HEADERS_BUF_SIZE;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h4 id="req-res-free-file">req res free file</h4>
<p>Close the file descriptor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> req_res_free_file(req_res_t* rr) {
	<span class="hljs-keyword">if</span> (rr-&gt;file != <span class="hljs-number">0</span>) {
		uv_fs_t close_req;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>NULL</code> as callback function makes the call synchron.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != uv_fs_close(loop, &amp;close_req, rr-&gt;file, NULL)) {
			<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_fs_close error\n"</span>);
		}
		uv_fs_req_cleanup(&amp;close_req);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h3 id="req-res-free">req res free</h3>
<p>Free all memory of one request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> req_res_free(req_res_t* rr) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Check for pending requests.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;pending_requests &gt; <span class="hljs-number">0</span>) {
		DEBUG(<span class="hljs-string">"req_res_free pending requests: %d\n"</span>, rr-&gt;pending_requests);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Close the stream if it is not already closed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!uv_is_closing((uv_handle_t *) rr-&gt;stream)) {
			uv_close((uv_handle_t *) rr-&gt;stream, on_close);
			rr-&gt;stream = NULL;
		}
		rr-&gt;dead = <span class="hljs-number">1</span>;
		<span class="hljs-keyword">return</span>;
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rr-&gt;dead) {
		DEBUG(<span class="hljs-string">"req_res_free free dead request\n"</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Free the <code>path</code> string.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;path != NULL) <span class="hljs-built_in">free</span>(rr-&gt;path);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Free the read buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;file_buf != NULL) {
		<span class="hljs-built_in">free</span>(rr-&gt;file_buf-&gt;base);
		<span class="hljs-built_in">free</span>(rr-&gt;file_buf);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Free the headers buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;headers_buf != NULL) {
		<span class="hljs-built_in">free</span>(rr-&gt;headers_buf-&gt;base);
		<span class="hljs-built_in">free</span>(rr-&gt;headers_buf);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Close the file descriptor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	req_res_free_file(rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Close the stream if it is not already closed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;stream != NULL &amp;&amp; !uv_is_closing((uv_handle_t *) rr-&gt;stream)) {
		uv_close((uv_handle_t *) rr-&gt;stream, on_close);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Free the state struct.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-built_in">free</span>(rr);
	DEBUG(<span class="hljs-string">"concurrent_states (-1): %zu\n"</span>, --concurrent_states);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h1 id="event-dispatcher">Event dispatcher</h1>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h2 id="send-headers-buf">send headers buf</h2>
<p>Create a tcp-stream-write-request, associate it with the state, and dispatch the
request. <a href="#on-tcp-write">on_tcp_write</a> gets called as soon as the buffer is
written to the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_headers_buf(req_res_t* rr) {
	uv_write_t* wr = (uv_write_t*) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_write_t));

	DEBUG(<span class="hljs-string">"send_headers_buf\n"</span>);

	wr-&gt;data = rr;
	rr-&gt;pending_requests++;
	<span class="hljs-keyword">if</span> (uv_write(wr, rr-&gt;stream, rr-&gt;headers_buf, <span class="hljs-number">1</span>, on_tcp_write)) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_write send_headers_buf failed\n"</span>);
		rr-&gt;pending_requests--;
		<span class="hljs-built_in">free</span>(wr);
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h2 id="send-file-buf">send file buf</h2>
<p>Create a tcp-stream-write-request, associate it with the state, and dispatch the
request. <a href="#on-tcp-write">on_tcp_write</a> gets called as soon as the buffer is
written to the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_file_buf(req_res_t* rr) {
	uv_write_t* wr = (uv_write_t*) <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_write_t));

	DEBUG(<span class="hljs-string">"send_file_buf\n"</span>);

	wr-&gt;data = rr;
	rr-&gt;pending_requests++;
	<span class="hljs-keyword">if</span> (uv_write(wr, rr-&gt;stream, rr-&gt;file_buf, <span class="hljs-number">1</span>, on_tcp_write)) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_write send_file_buf failed\n"</span>);
		rr-&gt;pending_requests--;
		<span class="hljs-built_in">free</span>(wr);
		req_res_free(rr);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <h2 id="open-path-as-file">open path as file</h2>
<p>Create a file-open-request, associate the state and dispatch it on the loop. The
<a href="#on-file-open">on_file_open</a> is invoked once the file is opened.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> open_path_as_file(req_res_t *rr) {
	<span class="hljs-keyword">int</span> r;
	uv_fs_t* file_open_req = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_fs_t));

	DEBUG(<span class="hljs-string">"read_file\n"</span>);

	file_open_req-&gt;data = rr;
	rr-&gt;pending_requests++;
	r = uv_fs_open(loop, file_open_req, rr-&gt;path, O_ASYNC | O_RDONLY, S_IFREG, on_file_open);
	<span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"open_path_as_file error: %d\n"</span>, r);
		rr-&gt;pending_requests--;
		<span class="hljs-built_in">free</span>(file_open_req);
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h2 id="read-file">read file</h2>
<p>Create a file-read-request and dispatch it.
<a href="#on-file-read">on_file_read</a> is invoked once the buffer is read from the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> read_file(req_res_t *rr) {
	<span class="hljs-keyword">int</span> r;
	uv_fs_t* fs_req = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_fs_t));

	DEBUG(<span class="hljs-string">"read_file\n"</span>);

	fs_req-&gt;data = rr;
	rr-&gt;pending_requests++;
	r = uv_fs_read(loop, fs_req, rr-&gt;file, rr-&gt;file_buf, <span class="hljs-number">1</span>, rr-&gt;file_pos, on_file_read);
	<span class="hljs-keyword">if</span>  (r != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"read error: %d\n"</span>, r);
		rr-&gt;pending_requests--;
		<span class="hljs-built_in">free</span>(fs_req);
		req_res_free(rr);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h1 id="helpers">Helpers</h1>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h2 id="send-not-found">send not found</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> send_not_found(req_res_t* rr) {
	DEBUG(<span class="hljs-string">"send_not_found\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><code>rr-&gt;close_after_write = 1</code> makes <code>on_tcp_write</code> close the connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rr-&gt;close_after_write = <span class="hljs-number">1</span>;
	<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"text/html"</span>, <span class="hljs-number">9</span>);
	rr-&gt;content_type_len = <span class="hljs-number">9</span>;
	set_headers(rr, <span class="hljs-string">"404 Not Found"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Check if <code>headers_buf</code> is initialized.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;headers_buf == NULL) <span class="hljs-keyword">return</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Check if the buffer is big enough to add the <code>Not found</code> body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;headers_buf-&gt;len+<span class="hljs-number">20</span> &gt;= HEADERS_BUF_SIZE) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"headers buffer too small: -3"</span>);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Add the body and set the new buffer size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base+rr-&gt;headers_buf-&gt;len, <span class="hljs-string">"&lt;h1&gt;Not Found&lt;/h1&gt;\n\0"</span>, <span class="hljs-number">20</span>);
	rr-&gt;headers_buf-&gt;len += <span class="hljs-number">20</span>;
	send_headers_buf(rr);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h2 id="set-headers-helper">set headers helper</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> set_headers(req_res_t* rr, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* code) {

	<span class="hljs-keyword">int</span> code_len = <span class="hljs-built_in">strlen</span>(code);

	DEBUG(<span class="hljs-string">"set_headers\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Initialize the headers buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	req_res_init_headers_buf(rr);

	<span class="hljs-keyword">int</span> pos = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">if</span> (code_len+<span class="hljs-number">9</span> &gt;= HEADERS_BUF_SIZE) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"headers buffer too small: -1"</span>);
		<span class="hljs-keyword">return</span>;
	}
	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base, <span class="hljs-string">"HTTP/1.1 "</span>, <span class="hljs-number">9</span>);
	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base+<span class="hljs-number">9</span>, code, code_len);
	pos = <span class="hljs-number">9</span>+code_len;</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Get the UTC <code>struct tm</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	time_t now = time(NULL);
	<span class="hljs-keyword">struct</span> tm* utc = gmtime(&amp;now);
	<span class="hljs-keyword">if</span> (utc == NULL) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"gmtime error"</span>);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Expand the headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (strftime(rr-&gt;headers_buf-&gt;base+pos, HEADERS_BUF_SIZE-pos, <span class="hljs-string">"\nDate: %a, %d %b %Y %H:%M:%S %Z\n"</span>, utc) == <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"strftime error"</span>);
		<span class="hljs-keyword">return</span>;
	}
	pos = <span class="hljs-built_in">strlen</span>(rr-&gt;headers_buf-&gt;base);

	<span class="hljs-keyword">if</span> (pos+<span class="hljs-number">17</span>+rr-&gt;content_type_len &gt;= HEADERS_BUF_SIZE) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"headers buffer too small: -2"</span>);
		<span class="hljs-keyword">return</span>;
	}
	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base+pos, <span class="hljs-string">"Content-Type: "</span>, <span class="hljs-number">14</span>);
	pos += <span class="hljs-number">14</span>;
	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base+pos, rr-&gt;content_type, rr-&gt;content_type_len);
	pos += rr-&gt;content_type_len;
	<span class="hljs-built_in">memcpy</span>(rr-&gt;headers_buf-&gt;base+pos, <span class="hljs-string">"\n\n"</span>, <span class="hljs-number">2</span>);
	pos += <span class="hljs-number">2</span>;

	rr-&gt;headers_buf-&gt;len = pos;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h2 id="simple-request-header-parser">Simple request header parser</h2>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Reads the buffer <code>req</code> and sets the <code>path</code> and <code>content_type</code> strings of
the state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> parse(<span class="hljs-keyword">const</span> uv_buf_t* req, req_res_t* rr) {

	<span class="hljs-keyword">if</span> (rr == NULL || req == NULL) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

	DEBUG(<span class="hljs-string">"parse\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Check if it is an <code>GET</code> request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(req-&gt;base, <span class="hljs-string">"GET "</span>, <span class="hljs-number">4</span>) != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Not a GET request\n"</span>);
		<span class="hljs-keyword">return</span> -<span class="hljs-number">2</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Search for the end of the <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">int</span> path_start = <span class="hljs-number">4</span>;
	<span class="hljs-keyword">int</span> path_len = <span class="hljs-number">0</span>;
	<span class="hljs-keyword">while</span> (path_len+path_start &lt; req-&gt;len) {
		<span class="hljs-keyword">if</span> (req-&gt;base[path_len+path_start] == <span class="hljs-string">' '</span>) {
			<span class="hljs-keyword">break</span>;
		}
		path_len++;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Validate the <code>path</code> length.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (path_len == <span class="hljs-number">0</span> || path_len &gt; MAX_PATH_SIZE) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Path invalid\n"</span>);
		<span class="hljs-keyword">return</span> -<span class="hljs-number">3</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Check if it is a <code>HTTP</code> version 1.* request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (path_start+path_len+<span class="hljs-number">7</span> &gt; req-&gt;len ||
		<span class="hljs-built_in">strncmp</span>(req-&gt;base+path_start+path_len, <span class="hljs-string">" HTTP/1"</span>, <span class="hljs-number">7</span>) != <span class="hljs-number">0</span>)
	{
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Not a HTTP/1 request\n"</span>);
		<span class="hljs-keyword">return</span> -<span class="hljs-number">4</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Allocate memory for the <code>path</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rr-&gt;path = <span class="hljs-built_in">malloc</span>(web_root_len+path_len+<span class="hljs-number">1</span>);
	<span class="hljs-keyword">if</span> (rr-&gt;path == NULL) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"malloc error\n"</span>);
		<span class="hljs-keyword">return</span> -<span class="hljs-number">5</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Copy the path and terminate it with <code>\0</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-built_in">strcpy</span>(rr-&gt;path, web_root);
	<span class="hljs-built_in">memcpy</span>(rr-&gt;path+web_root_len, req-&gt;base+path_start, path_len+<span class="hljs-number">1</span>);
	rr-&gt;path[path_len+web_root_len] = <span class="hljs-string">'\0'</span>;
	rr-&gt;path_len = path_len+web_root_len;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Set the content type based on the file extension.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(rr-&gt;path+rr-&gt;path_len-<span class="hljs-number">5</span>, <span class="hljs-string">".html"</span>, <span class="hljs-number">5</span>) == <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"text/html"</span>, <span class="hljs-number">9</span>);
		rr-&gt;content_type_len = <span class="hljs-number">9</span>;
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(rr-&gt;path+rr-&gt;path_len-<span class="hljs-number">3</span>, <span class="hljs-string">".js"</span>, <span class="hljs-number">3</span>) == <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"text/javascript"</span>, <span class="hljs-number">15</span>);
		rr-&gt;content_type_len = <span class="hljs-number">15</span>;
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(rr-&gt;path+rr-&gt;path_len-<span class="hljs-number">4</span>, <span class="hljs-string">".css"</span>, <span class="hljs-number">4</span>) == <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"text/css"</span>, <span class="hljs-number">8</span>);
		rr-&gt;content_type_len = <span class="hljs-number">8</span>;
	} <span class="hljs-keyword">else</span> {
		<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"application/octet-stream"</span>, <span class="hljs-number">24</span>);
		rr-&gt;content_type_len = <span class="hljs-number">24</span>;
	}

	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <h1 id="event-handlers">Event handlers</h1>
<h4 id="request-alloc">request alloc</h4>

            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Libuv does not allocate memory. Thus this function is provided to <code>uv_read_start</code> to
allocate memory for the request buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> request_alloc(uv_handle_t* handle, size_t suggested_size, uv_buf_t* buf) {
	buf-&gt;base = <span class="hljs-built_in">malloc</span>(suggested_size);
	buf-&gt;len = suggested_size;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <h4 id="on-close">on close</h4>
<p>Free the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_close(uv_handle_t* peer) {
	<span class="hljs-built_in">free</span>(peer);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h2 id="on-tcp-write">on tcp write</h2>
<p>Either close the connection or read</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_tcp_write(uv_write_t* req, <span class="hljs-keyword">int</span> status) {
	req_res_t* rr = (req_res_t*) req-&gt;data;
	rr-&gt;pending_requests--;</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Check if an error occurred in an other handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;dead) <span class="hljs-keyword">return</span> req_res_free(rr);
	
	DEBUG(<span class="hljs-string">"on_tcp_write\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Free the write request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-built_in">free</span>(req);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Check for write error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"on_tcp_write error: %s - %s\n"</span>, uv_err_name(status), uv_strerror(status));
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Either close the connection or read more data of the file.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;close_after_write) {
		DEBUG(<span class="hljs-string">"on_tcp_write is closing the connection\n"</span>);
		req_res_free(rr);
	} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rr-&gt;read_on_write) {
		rr-&gt;read_on_write = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p><code>read_file</code> triggers <a href="#on-file-open">on_file_open</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		read_file(rr);
	}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h2 id="on-file-read">on file read</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_file_read(uv_fs_t * req) {
	<span class="hljs-keyword">int</span> status = req-&gt;result;
	req_res_t* rr = (req_res_t*) req-&gt;data;
	rr-&gt;pending_requests--;</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Check if an error occurred in an other handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;dead) <span class="hljs-keyword">return</span> req_res_free(rr);
	
	DEBUG(<span class="hljs-string">"on_file_read %s\n"</span>, rr-&gt;path);</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Free the read request.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	uv_fs_req_cleanup(req);
	<span class="hljs-built_in">free</span>(req);</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Check for read error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span>(status &lt; <span class="hljs-number">0</span> &amp;&amp; status != UV_EOF) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"on_file_read error: %s\n"</span>, uv_strerror(status));
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Check if the whole file is already read.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (status == UV_EOF || status == <span class="hljs-number">0</span>) {
		DEBUG(<span class="hljs-string">"on_file_read reached end of file - closing connection\n"</span>);
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}
	
	DEBUG(<span class="hljs-string">"on_file_read %d bytes\n"</span>, status);
	
	rr-&gt;read_on_write = <span class="hljs-number">1</span>; <span class="hljs-comment">// Read until an error happens.</span>
	rr-&gt;file_pos += status; <span class="hljs-comment">// Update the file postion.</span>
	rr-&gt;file_buf-&gt;len = status; <span class="hljs-comment">// This will sometimes *shrink* the buffer.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><code>send_file_buf</code> triggers <a href="#on-tcp-write">on_tcp_write</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	send_file_buf(rr);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <h2 id="on-file-open">on file open</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_file_open(uv_fs_t* req) {
	<span class="hljs-keyword">char</span>* path_buf;
	<span class="hljs-keyword">int</span> r, status = req-&gt;result;
	req_res_t* rr = (req_res_t*) req-&gt;data;
	rr-&gt;pending_requests--;</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Check if an error occurred in an other handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;dead) <span class="hljs-keyword">return</span> req_res_free(rr);
	
	DEBUG(<span class="hljs-string">"on_file_open %s\n"</span>, rr-&gt;path);
	
	uv_fs_req_cleanup(req);
	<span class="hljs-built_in">free</span>(req);</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Check if <code>uv_fs_open</code> returned an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (status &lt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Send an <code>404</code> response only on <code>File not found</code> and <code>Illegal on directory</code> error.
Note: It is important to close the file on <code>EMFILE</code> and other errors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (status == UV_ENOENT || status == UV_EISDIR) {
			send_not_found(rr);
			<span class="hljs-keyword">return</span>;
		}
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"async open error '%s': %s\n"</span>, rr-&gt;path, uv_strerror(status));</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Close the file and free the memory.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>TODO: Recheck if it is possible to fail in <code>on_file_open</code> and get <code>status &lt; 0</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	uv_fs_t stat_req;
	uv_stat_t* s;
	r = uv_fs_stat(uv_default_loop(), &amp;stat_req, rr-&gt;path, NULL);
	<span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_fs_stat error '%s': %s\n"</span>, rr-&gt;path, uv_strerror(r));
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}

	s = &amp;stat_req.statbuf;
	<span class="hljs-keyword">if</span> (!S_ISREG(s-&gt;st_mode)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>If the file is a directory append <code>index.html</code> to the path and reopen it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (S_ISDIR(s-&gt;st_mode)) {
			<span class="hljs-keyword">if</span> (rr-&gt;path_len+<span class="hljs-number">10</span> &gt;= MAX_PATH_SIZE) {
				<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"headers buffer too small: -4"</span>);
				req_res_free(rr);
				<span class="hljs-keyword">return</span>;
			}
			path_buf = <span class="hljs-built_in">malloc</span>(rr-&gt;path_len+<span class="hljs-number">11</span>);
			<span class="hljs-built_in">memcpy</span>(path_buf, rr-&gt;path, rr-&gt;path_len);
			<span class="hljs-built_in">memcpy</span>(path_buf+rr-&gt;path_len, <span class="hljs-string">"index.html\0"</span>, <span class="hljs-number">11</span>);
			<span class="hljs-built_in">free</span>(rr-&gt;path);
			rr-&gt;path = path_buf;
			rr-&gt;path_len += <span class="hljs-number">10</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Set the content type.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-built_in">memcpy</span>(rr-&gt;content_type, <span class="hljs-string">"text/html"</span>, <span class="hljs-number">9</span>);
			rr-&gt;content_type_len = <span class="hljs-number">9</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Close the directory file handle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			rr-&gt;file = status;
			req_res_free_file(rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Open the new path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			open_path_as_file(rr);
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Not a file or directory, send a <code>404</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			send_not_found(rr);
		}
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Store the file handle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rr-&gt;file = status;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Send the <code>200</code> response headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	rr-&gt;read_on_write = <span class="hljs-number">1</span>;
	req_res_init_file_buf(rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Send the <code>200</code> response headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	set_headers(rr, <span class="hljs-string">"200 OK"</span>);
	send_headers_buf(rr);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <h2 id="on-tcp-read">on tcp read</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_tcp_read(uv_stream_t* handle, ssize_t nread, <span class="hljs-keyword">const</span> uv_buf_t* buf) {
	<span class="hljs-keyword">int</span> r;
	req_res_t *rr = (req_res_t*) handle-&gt;data;
	

	DEBUG(<span class="hljs-string">"on_tcp_read\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Check if an error occurred in an other handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;dead) <span class="hljs-keyword">return</span> req_res_free(rr);</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>Check if <code>uv_read</code> returned an error.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (nread &lt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Print every error except end of file (UV_EOF).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (nread != UV_EOF) {
			<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"on_tcp_read error: %s\n"</span>, uv_err_name(nread));
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>Free the memory allocated by <code>request_alloc</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (buf-&gt;base) 
			<span class="hljs-built_in">free</span>(buf-&gt;base);</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Close the stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}
	
	<span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Everything OK, but nothing read.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-built_in">free</span>(buf-&gt;base);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Check if an previous <code>on_tcp_read</code> has parsed the headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (rr-&gt;path != NULL) {
		DEBUG(<span class="hljs-string">"on_tcp_read on already parsed headers\n"</span>);
		<span class="hljs-built_in">free</span>(buf-&gt;base);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Parse the request headers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = parse(buf, rr);
	<span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) {
		req_res_free(rr);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>The state object contains now all parsed headers, free the request buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">if</span> (buf-&gt;base) 
		<span class="hljs-built_in">free</span>(buf-&gt;base);
	
	DEBUG(<span class="hljs-string">"path: %s\n"</span>, rr-&gt;path);
	
	open_path_as_file(rr); <span class="hljs-comment">// `open_path_as_file` triggers [on file open](#on-file-open)</span>
}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <h2 id="on-connection">on connection</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> on_connection(uv_stream_t* server, <span class="hljs-keyword">int</span> status) {
	<span class="hljs-keyword">int</span> r;
	req_res_t *rr;
	uv_stream_t* stream;
	
	DEBUG(<span class="hljs-string">"on_connection\n"</span>);
	
	<span class="hljs-keyword">if</span> (status != <span class="hljs-number">0</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Connect error %s\n"</span>, uv_err_name(status));
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Create a new stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	stream = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(uv_tcp_t));
	<span class="hljs-keyword">if</span> (stream == NULL) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"malloc error\n"</span>);
		<span class="hljs-keyword">return</span>;
	}
	r = uv_tcp_init(loop, (uv_tcp_t*)stream);
	<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_tcp_init error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span>;
	}
	
	DEBUG(<span class="hljs-string">"creating new req_res\n"</span>);
	rr = req_res_init(stream);
	<span class="hljs-keyword">if</span> (rr == NULL) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"malloc error\n"</span>);
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Associate the state with stream.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	stream-&gt;data = rr;</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Accept the connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = uv_accept(server, stream);
	<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_accept error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>Start reading on the stream and register the <a href="#on-tcp-read">on_tcp_read</a>
handler. Libuv will call <a href="#request-alloc">request_alloc</a> to allocate memory for
the request buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = uv_read_start(stream, request_alloc, on_tcp_read);
	<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"uv_read_start error %s\n"</span>, uv_err_name(r));
	}

}</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <h1 id="main">main</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">int</span> main(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[]) {
	<span class="hljs-keyword">struct</span> sockaddr_in addr;
	<span class="hljs-keyword">int</span> r, port;
	
	<span class="hljs-keyword">if</span> (argc != <span class="hljs-number">4</span>) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"usage: %s &lt;ip&gt; &lt;port&gt; &lt;web-root&gt;\n"</span>, argv[<span class="hljs-number">0</span>]);
		<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Create the libuv event loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	loop = uv_default_loop();
	
	web_root = argv[<span class="hljs-number">3</span>];
	web_root_len = <span class="hljs-built_in">strlen</span>(web_root);
	port = (<span class="hljs-keyword">int</span>)strtol(argv[<span class="hljs-number">2</span>], NULL, <span class="hljs-number">0</span>);
	r = uv_ip4_addr(argv[<span class="hljs-number">1</span>], port, &amp;addr);
	<span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Listen error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>Create a new TCP socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = uv_tcp_init(loop, &amp;tcp_server);
	<span class="hljs-keyword">if</span> (r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Socket creation error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>Bind the socket to the IPv4 address and port.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = uv_tcp_bind(&amp;tcp_server, (<span class="hljs-keyword">const</span> <span class="hljs-keyword">struct</span> sockaddr*) &amp;addr, <span class="hljs-number">0</span>);
		<span class="hljs-keyword">if</span> (r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Bind error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>Register the <a href="#on-connection">on_connection</a> handler for connections on
the socket. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r = uv_listen((uv_stream_t*)&amp;tcp_server, SOMAXCONN, on_connection);
	<span class="hljs-keyword">if</span> (r) {
		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Listen error %s\n"</span>, uv_err_name(r));
		<span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
	}
	
	DEBUG(<span class="hljs-string">"Server listen on %s:%d serving %s\n"</span>, argv[<span class="hljs-number">1</span>], port, web_root);</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Start the event loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	uv_run(loop, UV_RUN_DEFAULT);

	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
